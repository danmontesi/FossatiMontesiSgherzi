 <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>Starter Template - Materialize</title>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
</head>
<body>


    <div class="navbar-fixed">
        <nav>
          <div class="nav-wrapper">
            <a href="#!" class="brand-logo">Data4Help Website</a>
            <ul class="right hide-on-med-and-down">
              <li><a href="dashboard.html">Dashboard</a></li>
                
              <li><a href="subscription.html">Subscription Plans</a></li>

              <li><a href="query.html">Query</a></li>

              <li class="active"><a href="monitoring.html">Monitoring</a></li>
  
              <button href="#!" onclick=signOut() class="btn transparent modal-trigger">Sign out</button>
              
            </ul>
          </div>
        </nav>
      </div>



      

      <div class="section no-pad-bot" id="index-banner">
          <div class="container">

              <div class="container">
                  <div class="section">
              
              
                      <div class="row center">
                          <h5 class="header col s12 ">Data4Help let companies monitor single individuals, previus their approval.</h5>
                          <h5 class="center">
                            <button data-target="modal" class="btn red modal-trigger">Add new individual query</button>
                            </h5>
                            
                          <h7 class="header col s12">Here is the list of your performed individual query.  
                              To see data, click on the id button:
                          </h5>

                          <h6 id="loading_panel" class="header col s12 light"></h5>
                          
                        </div>
                  
          </div>
        </div>



      
        <ul id="start_collection" class="collection">
        </ul>

        </div>

      </div>
      
          <footer class="page-footer orange">
              <div class="container">
                <div class="row">
                  <div class="col l6 s12">
                    <h5 class="white-text">TrackMe</h5>
                    <p class="grey-text text-lighten-4">TrackMe is a company that wants to offer an innovative service to companies in order monitor their individuals, for medical purpose and not only.
                      Data4Help is available for all users and it is totally free.
                    </p>
          
          
                  </div>
                  <div class="col l3 s12">
                   
                  </div>
                  <div class="col l3 s12">
                  
                    <ul>
                      
                    </ul>
                  </div>
                </div>
              </div>
              <div class="footer-copyright">
                <div class="container">
                </div>
              </div>
          
              
            </footer>


          </body>

  <!--  Scripts-->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="js/materialize.js"></script>
  <script src="js/init.js"></script>


  <script>
      $(document).ready(
        function () {
         $('.modal').modal({
            dismissible: true
          });

        
        if (getCookie("auth_token")==""){
          alert("You are not logged in! \nSign in first.")/*displays error message*/
          document.location.href = "index.html";
        }
        else{
          console.log("calling get patient list ")
          getPatientList()

          //TODO : Authenticated-> Retrieve all useful information


        }
        //check the authCode != ""
        //if null-> get error message and don't show anything

        //else-> request list of queries from server and shows them in the dashboard


      });

</script>

<script>

  function getPatientList() {

  
  document.getElementById("loading_panel").innerHTML = `
                        
                        <span class="title">Loading queries ...</span>
                         
                       `;
                             
  const proxyurl = "https://cors-anywhere.herokuapp.com/";
  const url = "https://data4halp.herokuapp.com/queries/query?auth_token=" + getCookie("auth_token");

  fetch(proxyurl + url, {

    method: 'GET',
    headers: {
 		'Content-Type': 'application/json'
    }


  }) 
  
    .then(response => response.json())
    .then(response => { //Assign to contents the response
    console.log("here in response ")

    console.log(response)
    document.getElementById("loading_panel").innerHTML = ``;
      if (response["success"] === true) {

        console.log(response)
        //creating inner html to append to the page
        var HtmlToAppend = ""
        decodedResponse = response.queries.individual;
        if (decodedResponse){       

        for (var i = 0; i < decodedResponse.length; i++) {
          curQuery = decodedResponse[i]; //TODO SOTTO: create query click
          HtmlToAppend += `
                        <ul class="collection">
                <li class="collection-item avatar">
                  <img query_id = ${curQuery["id"]} src="images/data_icon.png" alt="" class="circle"  >
                  <span class="title">Patient SSN</span>
                  <p>${curQuery["ssn"]}<br>
                    <button href="#!" onclick=createXml(${curQuery["id"]}) class="btn red">Download query</button>
                  </p>
                  <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
                </li>
              </ul>
                `
              
        }
        document.getElementById("start_collection").innerHTML = HtmlToAppend;
            
        
      }
      else {
        alert("Endpoint of get_query still not working, filling last query with provisory data")
        var htmlToAppend = ""
        htmlToAppend += `
                        <ul class="collection">
                <li class="collection-item avatar">
                  <img src="images/data_icon.png" alt="" class="circle">
                  <span class="title">ToBeFilled once endpoint works</span>
                  <p>!!<br>
                    Data4Help
                  </p>
                  <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
                </li>
              </ul>
                `
        htmlToAppend += `
                        <ul class="collection">
                <li class="collection-item avatar">
                  <img src="images/data_icon.png" alt="" class="circle">
                  <span class="title">!!</span>
                  <p>!!<br>
                    Data4Help
                  </p>
                  <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
                </li>
              </ul>
                `
                htmlToAppend += `
                        <ul class="collection">
                <li class="collection-item avatar">
                  <img src="images/data_icon.png" alt="" class="circle">
                  <span class="title">!!</span>
                  <p>!!<br>
                    Data4Help
                  </p>
                  <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
                </li>
                </ul>
                `
                htmlToAppend += `
                        <ul class="collection">
                <li class="collection-item avatar">
                  <img src="images/data_icon.png" alt="" class="circle">
                  <span class="title">!!</span>
                  <p>!!<br>
                    Data4Help
                  </p>
                  <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
                </li>
              </ul>
                `
                htmlToAppend += `
                        <ul class="collection">
                <li class="collection-item avatar">
                  <img src="images/data_icon.png" alt="" class="circle">
                  <span class="title">!!</span>
                  <p>!!<br>
                    Data4Help
                  </p>
                  <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
                </li>
              </ul>
                `
        document.getElementById("start_collection").innerHTML += htmlToAppend
        //alert("Error: You must login to see this page")/*displays error message*/
        //document.href("index.html")
      }
      }
    }
    )
    .catch((e) => console.log("Canâ€™t access " + url + " response. Blocked by browser?" + e))
}

</script>


  <script>
  function signOut(){
    deleteAllCookies();
    document.location.href = "index.html";
    alert("You have logged out.");/*displays info */
    
  }
  </script>

    <script>
      function sendQuery() {
        const proxyurl = "https://cors-anywhere.herokuapp.com/";
        const url = "https://data4halp.herokuapp.com/queries/query";
      var auth_token = getCookie("auth_token");//get authtoken
        var SSN = $('#ssn').val();
   
        fetch(proxyurl + url, {

          method: 'POST',
          headers: new Headers({
     'Content-Type': 'application/json'
   }),
   body: JSON.stringify({
     auth_token: auth_token,
     query: {
       type: 'individual',
       ssn: SSN,
       additional_params: {
      
    }
  }
   }
        )
      })
          .then(response => response.text())
          .then(contents => { //Assign to contents the response
            var myObj = JSON.parse(contents); //Parse the response
            if (myObj["success"] == true) {
              $('.modal.open').modal('close')
              $("#modal1").modal();
              $("#modal1").modal('open');
            }
            else {
              alert("Error:" + myObj["message"] + ".\nRetry!")
            }

          });
      }
          
    </script>


<script>
  function addPatient() {
    const proxyurl = "https://cors-anywhere.herokuapp.com/";
    const url = "https://data4halp.herokuapp.com/patient/TODO"; //TODO
    var authtoken = getCookie("auth_token");//get authtoken
    var SSN = $('#SSN').val();

    
    fetch(proxyurl + url, {

      method: 'POST',
      body: { 
        //TODO
      }

    })
      .then(response => response.text())
      .then(contents => { //Assign to contents the response
        var myObj = JSON.parse(contents); //Parse the response
        if (myObj["status"] == 200) {
          $('.modal.open').modal('close')
          $("#modal-success").modal();
          $("#modal1").modal('open');
        }
        else {
          alert("Error:" + myObj["message"] + ".\nRetry!")
        }

      });
  }
      
</script>

<script>
  function deleteAllCookies() {
    var cookies = document.cookie.split(";");

    for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i];
        var eqPos = cookie.indexOf("=");
        var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
    }
}
</script>

<script>
    function getCookie(cname) {
      var name = cname + "=";
      var decodedCookie = decodeURIComponent(document.cookie);
      var ca = decodedCookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }</script>


<!-- Function get Xml from  server endpoint-->
<script>
    function createXml(query_id) {

      const proxyurl = "https://cors-anywhere.herokuapp.com/";
      const url = "https://data4halp.herokuapp.com/queries/query/data";
      var authtoken = getCookie("auth_token");//get authtoken
      var query_id = query_id;
      fetch(proxyurl + url + "?auth_token=" + authtoken + "&query_id=" + query_id, {

        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }

      })
        .then(response => response.text())
        .then(contents => { //Assign to contents the response
          var myObj = JSON.parse(contents); //Parse the response
          if (myObj["success"] == true) {
            //Show the json file
  //window.webkitRequestFileSystem(window.TEMPORARY, 1024*1024, SaveDatFileBro);
console.log("contents:"+myObj.data);
var xml = json2xml(contents);
            download_file(query_id + ".txt", xml, "text/plain")

          }
          else {
            alert("Error:" + myObj["message"] + ".\nRetry!")
          }

        });
    }
  </script>

<script>
function json2xml(json) {
    var a = JSON.parse(json)
    var c = document.createElement("root");
    var t = function (v) {
        return {}.toString.call(v).split(' ')[1].slice(0, -1).toLowerCase();
    };
    var f = function (f, c, a, s) {
        c.setAttribute("type", t(a));
        if (t(a) != "array" && t(a) != "object") {
            if (t(a) != "null") {
                c.appendChild(document.createTextNode(a));
            }
        } else {
            for (var k in a) {
                var v = a[k];
                if (k == "__type" && t(a) == "object") {
                    c.setAttribute("__type", v);
                } else {
                    if (t(v) == "object") {
                        var ch = c.appendChild(document.createElementNS(null, s ? "item" : k));
                        f(f, ch, v);
                    } else if (t(v) == "array") {
                        var ch = c.appendChild(document.createElementNS(null, s ? "item" : k));
                        f(f, ch, v, true);
                    } else {
                        var va = document.createElementNS(null, s ? "item" : k);
                        if (t(v) != "null") {
                            va.appendChild(document.createTextNode(v));
                        }
                        var ch = c.appendChild(va);
                        ch.setAttribute("type", t(v));
                    }
                }
            }
        }
    };
    f(f, c, a, t(a) == "array");
    return c.outerHTML;
}
</script>
<script>
    function download_file(name, contents, mime_type) {
        mime_type = mime_type || "text/plain";

        var blob = new Blob([contents], {type: mime_type});

        var dlink = document.createElement('a');
        dlink.download = name;
        dlink.href = window.URL.createObjectURL(blob);
        dlink.onclick = function(e) {
            // revokeObjectURL needs a delay to work properly
            var that = this;
            setTimeout(function() {
                window.URL.revokeObjectURL(that.href);
            }, 1500);
        };

        dlink.click();
        dlink.remove();
    }</script>
 <!-- Modal Trigger for Successful Query add-->
 <a class="modal-trigger"href="#modal1"></a>

 <!-- Modal Structure -->
 <div id="modal1" class="modal" >
   <div class="modal-content ">
     <h4>Success</h4>
     <p>Request has been sent. The query will be available in this page once the individual accepts to be monitored.</p>

   </div>
   <div class="modal-footer">
     <a href="#!" class="modal-close waves-effect transparent btn-flat">Done</a>
   </div>
 </div>


    <!-- Modal Structure QueryForm -->
    <div id="modal" class="modal">
        <div class="modal-content">
          <div class="row">
            <form class="col s12">
    
              <div class="col s12">
                <p id=demo>Please insert SSN of the patient you want to monitor: </p>
              </div>

              <div class="row">
                  <div class="input-field col s12">
                    <input id="ssn" type="text" class="validate">
                    <label for="ssn">SSN of monitored patient</label>
                  </div>
                </div>

              <div class="modal-footer">
                <a href="#!" class="waves-effect waves-green btn-flat" onclick="sendQuery()">Send</a>
              </div>
          </div>
    
        </div>
      </div>





</html>
